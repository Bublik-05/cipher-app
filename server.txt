require('dotenv').config(); // Подключение dotenv до использования process.env
const express = require('express');
const path = require('path');
const axios = require('axios');
const cors = require('cors'); // Подключение CORS

const app = express(); // Инициализация Express
const apiKey = process.env.OPENWEATHER_API_KEY;// Считываем ключ OpenWeather API
console.log('Loaded API Key:', apiKey); // Лог API-ключа

app.use(cors()); // Подключение CORS
app.use(express.json()); // Обработка JSON


// Статические файлы
app.use(express.static(path.join(__dirname, '../public')));

// Корневой маршрут
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, '../public', 'index.html'));
});

// Маршрут для получения данных о погоде
app.get('/api/weather', async (req, res) => {
    const { city } = req.query;

    if (!city) {
        console.log('City not provided in request');
        return res.status(400).send('City is required');
    }

    const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`;
    console.log('Weather API request URL:', url);

    try {
        const response = await axios.get(url);
        console.log('Weather API response:', response.data);
        res.json(response.data);
    } catch (error) {
        console.error('Error fetching weather data:', error.response?.data || error.message);
        res.status(500).send('Ошибка при получении данных о погоде');
    }
});



// Маршрут для получения курсов валют
app.get('/api/currency', async (req, res) => {
    const base = req.query.base || 'USD'; // Базовая валюта
    const apiKey = process.env.EXCHANGE_RATE_API_KEY; // Ключ из .env
    const url = `https://v6.exchangerate-api.com/v6/${apiKey}/latest/${base}`;

    try {
        const response = await axios.get(url);
        res.json(response.data.conversion_rates); // Отправляем только курсы
    } catch (error) {
        console.error('Error fetching currency rates:', error.response?.data || error.message);
        res.status(500).send('Ошибка при получении курсов валют');
    }
});


// Маршрут для получения новостей
app.get('/api/news', async (req, res) => {
    const { country } = req.query; // Страна для фильтрации новостей
    const apiKey = process.env.NEWS_API_KEY; // Ключ из .env
    const url = `https://newsapi.org/v2/top-headlines?country=${country}&apiKey=${apiKey}`;

    try {
        const response = await axios.get(url);
        res.json(response.data.articles); // Отправляем только статьи
    } catch (error) {
        console.error('Error fetching news:', error.response?.data || error.message);
        res.status(500).send('Ошибка при получении новостей');
    }
});


// Маршрут для получения прогноза погоды
app.get('/api/forecast', async (req, res) => {
    const { lat, lon } = req.query;
    const apiKey = process.env.OPENWEATHER_API_KEY;
    const url = `https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&exclude=current,minutely,hourly,alerts&appid=${apiKey}&units=metric`;

    try {
        const response = await axios.get(url);
        res.json(response.data.daily); // Отправляем только ежедневный прогноз
    } catch (error) {
        console.error('Error fetching forecast data:', error.response?.data || error.message);
        res.status(500).send('Ошибка при получении прогноза погоды');
    }
});


// Запуск сервера
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server is running on port ${PORT}`));
